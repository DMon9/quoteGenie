<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auth0 Callback - EstimateGenie</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <header class="bg-white border-b">
      <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="/" class="flex items-center gap-2">
          <span class="text-purple-600 font-extrabold text-xl">EstimateGenie</span>
          <span class="text-gray-400">Â·</span>
          <span class="text-gray-600">Quote Builder</span>
        </a>
        <div>
          <a href="/" class="text-sm text-purple-700 hover:underline">Home</a>
        </div>
      </div>
    </header>
    <div
      class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8"
    >
      <div class="max-w-md w-full space-y-8">
        <div class="text-center">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"
          ></div>
          <h2 class="mt-6 text-center text-2xl font-bold text-gray-900">
            Completing sign in...
          </h2>
          <p id="status" class="mt-2 text-center text-sm text-gray-600">
            Please wait while we authenticate you
          </p>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = window.location.origin;
      const REDIRECT_URI = window.location.origin + "/callback";

      async function handleCallback() {
        const statusEl = document.getElementById("status");

        // Get authorization code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const error = urlParams.get("error");
        const errorDescription = urlParams.get("error_description");

        if (error) {
          statusEl.textContent = `Error: ${errorDescription || error}`;
          statusEl.className = "mt-2 text-center text-sm text-red-600";
          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
          return;
        }

        if (!code) {
          statusEl.textContent = "Error: No authorization code received";
          statusEl.className = "mt-2 text-center text-sm text-red-600";
          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
          return;
        }

        // Verify state (optional but recommended)
        const savedState = sessionStorage.getItem("auth0_state");
        if (savedState && savedState !== state) {
          statusEl.textContent = "Error: Invalid state parameter";
          statusEl.className = "mt-2 text-center text-sm text-red-600";
          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
          return;
        }

        try {
          statusEl.textContent = "Exchanging authorization code...";

          // Exchange code for tokens
          const response = await fetch(
            `${API_BASE_URL}/api/v1/auth/auth0/callback?code=${encodeURIComponent(
              code
            )}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`,
            {
              method: "POST",
            }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Authentication failed");
          }

          const data = await response.json();

          statusEl.textContent =
            "Authentication successful! Saving credentials...";

          // Store tokens in localStorage
          localStorage.setItem("auth_token", data.access_token);
          localStorage.setItem("api_key", data.user.api_key);
          localStorage.setItem("user_email", data.user.email);
          localStorage.setItem("user_name", data.user.name);
          localStorage.setItem("user_plan", data.user.plan);

          // Clear session state
          sessionStorage.removeItem("auth0_state");

          statusEl.textContent = "Success! Redirecting...";
          statusEl.className = "mt-2 text-center text-sm text-green-600";

          // Redirect to homepage (quote builder)
          setTimeout(() => {
            window.location.href = "/";
          }, 1000);
        } catch (error) {
          console.error("Callback error:", error);
          statusEl.textContent = "Error: " + error.message;
          statusEl.className = "mt-2 text-center text-sm text-red-600";

          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
        }
      }

      // Run callback handler when page loads
      handleCallback();
    </script>
  </body>
</html>
