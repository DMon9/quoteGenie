name: Cloudflare DNS Automation

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run in dry-run mode (no changes)"
        required: false
        default: "false"
      force:
        description: "Force update even if records match"
        required: false
        default: "false"
      zoneName:
        description: "Root domain (default estimategenie.net)"
        required: false
        default: ""
      pagesProject:
        description: "Cloudflare Pages project (default estimategenie)"
        required: false
        default: ""
      target:
        description: "CNAME target (default estimategenie.pages.dev)"
        required: false
        default: ""
  push:
    branches: [main]
    paths:
      - "**/*.html"
      - "assets/**"
      - "frontend/**"
      - "deploy/**"
      - "scripts/update_dns_records.ps1"

concurrency:
  group: ci-dns-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-dns:
    name: Update DNS records and verify
    runs-on: windows-latest
    timeout-minutes: 15
    permissions:
      contents: read
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show configuration
        shell: pwsh
        run: |
          Write-Host "Event: $env:GITHUB_EVENT_NAME"
          Write-Host "DryRun: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run }}"
          Write-Host "Force: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force }}"

      - name: Run DNS automation script
        shell: pwsh
        run: |
          if (-not $env:CLOUDFLARE_API_TOKEN) { throw 'CLOUDFLARE_API_TOKEN secret is required' }
          $params = @()
          $zoneName = '${{ github.event.inputs.zoneName }}'
          $pagesProject = '${{ github.event.inputs.pagesProject }}'
          $target = '${{ github.event.inputs.target }}'
          if ($zoneName) { $params += "-ZoneName '$zoneName'" }
          if ($pagesProject) { $params += "-PagesProject '$pagesProject'" }
          if ($target) { $params += "-Target '$target'" }
          $isDispatch = '${{ github.event_name }}' -eq 'workflow_dispatch'
          if ($isDispatch -and '${{ github.event.inputs.force }}' -eq 'true') { $params += '-Force' }
          if ($isDispatch -and '${{ github.event.inputs.dry_run }}' -eq 'true') { $params += '-DryRun' }
          $command = "./scripts/update_dns_records.ps1 " + ($params -join ' ')
          Write-Host "Running: $command"
          pwsh -File ./scripts/update_dns_records.ps1 @params

      - name: Verify titles (skip on dry-run)
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.dry_run != 'true' }}
        shell: pwsh
        run: |
          $retries = 8
          $delay = 20
          $expected = "Estimation Wizard"
          $zone = '${{ github.event.inputs.zoneName }}'
          if (-not $zone) { $zone = 'estimategenie.net' }
          $urls = @("https://$zone/", "https://www.$zone/")
          $allOk = $false
          for ($i=1; $i -le $retries; $i++) {
            $batchOk = $true
            Write-Host "Attempt $i/$retries"
            foreach ($u in $urls) {
              try {
                $r = Invoke-WebRequest -Uri $u -UseBasicParsing -Headers @{"Cache-Control"="no-cache, no-store"}
                $html = $r.Content
                $s = $html.IndexOf('<title>')
                $e = $html.IndexOf('</title>')
                $t = if ($s -ge 0 -and $e -gt $s) { $html.Substring($s+7, $e-$s-7) } else { '(no-title)' }
                Write-Host "$u => $t"
                if ($t -notlike "*${expected}*") { $batchOk = $false }
              } catch {
                Write-Host "Error fetching $u: $_"
                $batchOk = $false
              }
            }
            if ($batchOk) { $allOk = $true; break }
            Start-Sleep -Seconds $delay
          }
          if (-not $allOk) { throw "Expected title fragment not found for one or more URLs." }
